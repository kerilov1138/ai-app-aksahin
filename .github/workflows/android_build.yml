name: build_release
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Auto-Build Web Content (Source to Build)
        run: |
          cd assets/www
          if [ -f "package.json" ]; then
            echo "package.json detected. Running cloud build..."
            npm install
            npm run build || echo "Build failed or no build script, continuing..."
            
            # Detect build output folder
            for folder in dist build out web-build; do
              if [ -d "$folder" ]; then
                echo "Found build folder: $folder"
                # Move build result to root of assets/www
                mv "$folder"/* . 
                break
              fi
            done
          else
            echo "No package.json found. Mirroring assets directly."
          fi
          cd ../..

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Initialize Flutter Project
        run: |
          # Use dynamic org to ensure unique package IDs (different apps)
          flutter create . --platforms=android --org com.kur___lem_
          rm -rf test 
      
      - name: Dynamic Asset Mapper (Register Global Assets)
        run: |
          echo "Scanning for production assets in assets/www..."
          # Find directories, excluding dev artifacts and already registered ones
          FOLDERS=$(find assets/www -maxdepth 4 -type d \
            ! -path "*/node_modules*" \
            ! -path "*/.git*" \
            ! -path "*/.next*" \
            ! -name "." \
            ! -name "www")
          
          # We use a temp file to build the new list safely
          touch assets_to_add.txt
          for folder in $FOLDERS; do
            clean_folder="${folder//\\//}" # Fix slashes
            if ! grep -q "$clean_folder/" pubspec.yaml; then
              echo "    - $clean_folder/ # CLOUD-MAPPED" >> assets_to_add.txt
            fi
          done
          
          if [ -s assets_to_add.txt ]; then
            echo "Adding new assets to pubspec.yaml..."
            # Insert the content of assets_to_add.txt BEFORE the '# END ASSETS' marker
            sed -i "/# END ASSETS/r assets_to_add.txt" pubspec.yaml
          fi
          
          echo "Final pubspec.yaml assets section:"
          grep -A 50 "assets:" pubspec.yaml

      - run: flutter pub get
      - name: Create Native Splash
        run: dart run flutter_native_splash:create
      - run: flutter build apk --release
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.0
          name: App Release v1.0.0
          draft: false
          prerelease: false
          files: build/app/outputs/flutter-apk/app-release.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
